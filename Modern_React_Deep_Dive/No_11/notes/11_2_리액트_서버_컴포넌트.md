# 리액트 서버 컴포넌트

## 기존 리액트 컴포넌트와 서버 사이드 렌더링의 한계
### 클라이언트 사이드 렌더링의 한계
- 자바스크립트 번들 크기가 0인 컴포넌트를 만들 수 없다: 게시판 등 사용자가 작성한 HTML에 위험한 태그를 제거하기 위해 라이브러리를 사용해햐 한다.(사용자 기기의 부담으로 이어짐)
- 백엔드 리소스에 직접접근 불가능
- 자동 코드 분할 불가능: 코드 분할이란, 하나의 거대한 코드 번들 대신, 코드를 여러 작은 단위로 나누어 필요할 때만 동적으로 지연 로딩함으로서 앱을 초기화하는 속도를 높여주는 기법을 말한다.(React -> `lazy`를 사용한 구현)
    - 일일이 컴포넌트를 `lazy`로 감싸야하고, 정말 지연 로딩을 해도 되는 컴포넌트인지 판단해야하지만, 실수할 가능성이 높음
- 연쇄적으로 발생하는 클라이언트와 서버의 요청을 대응하기 어려움
- 추상화에 드는 비용이 증가: 다양한 기능을 사용할 수 있지만, 그만큼의 비용이 든다.

### 서버 사이드 렌더링의 한계
- 사용자의 인터렉션에 따른 다양한 사용자 경험을 제공하기 어려움

## 서버 컴포넌트란?
- 하나의 프레임워크, 하나의 언어, 하나의 API와 개념을 사용하면서 서버와 클라이언트 모두에서 컴포넌트를 렌더링할 수 있는 기법
- 서버에서 할 수 있는 일은 서버가, 서버에서 할 수 없는 작업은 클라이언트인 브라우저에서 수행
- 컴포넌트별 렌더링을 구분(서버/클라이언트)
- 클라이언트 컴포넌트는 서버 컴포넌트를 `import` 불가

### 컴포넌트별 제약사항
> 서버 컴포넌트
- 요청이 오면 그순간 서버에서 딱 한 번 실행될 뿐이므로 상태가 없음(상태를 갖는 훅을 사용할 수 없음)
- 렌더링 생명주기 사용 불가능
- DOM API, window, document등 접근 불가능
- 데이터베이스, 내부 서비스, 파일 시스템 등 서버에만 있는 데이터를 async/await으로 접근 가능(async 컴포넌트 가능)
- 다른 서버 컴포넌트를 렌더링하거나 `div`, `span`, `p` 같은 요소를 렌더링하거나 혹은 클라이언트 컴포넌트를 렌더링할 수 있다.

> 클라이언트 컴포넌트('use client' 명시)
- 브라우저 환경에서만 실행되므로 서버 컴포넌트를 불러오거나, 서버 전용 훅이나 유틸리티를 불러올 수 없다.
- 서버 컴포넌트가 클라이언트 컴포넌트를 렌더링하는데, 그 클라이언트 컴포넌트가 자식으로 서버 컴포넌트를 갖는 구조는 가능(이미 만들어진 트리를 삽입해서 보여주기 때문)
- 이외는 React와 동일

> 공용 컴포넌트(shared components)
- 이 컴포넌트는 서버와 클라이언트 모두에서 사용할 수 있음, 공통으로 사용할 수 있는 만큼, 당연히 서버 컴포넌트와 클라이언트 컴포넌트의 모든 제약을 받는다.

### 서버의 컴포넌트 인지 방법
- 모두 공용 컴포넌트로 판단
- `'use client'`를 통해 클라이언트 컴포넌트 판단(최신)


### !필수!
- 반드시 특정 프레임워크의 도움을 받는 것이 편함
- 여러가지 제약 요소가 많아서 직접 구현하는데 어려움이 많음
- 공식문서 또한 웹팩과 자체적인 서버 번들링을 위한 react-server-dom-webpack을 만들어 활용

## 서버 사이드 렌더링과 서버 컴포넌트의 차이

### 서버 사이드 렌더링
- 응답 받은 페이지 전체를 HTML로 렌더링하는 과정을 서버에서 수행 한 후 그 결과를 클라이언트에 전달
- 초기에 인터랙션은 불가능하지만 정적인 HTML을 빠르게 내려주는데 초점을 두어 현재도 초기 HTML 로딩 이후에는 클라이언트에서 자바스크립트 코드를 다운로드하고 파싱하고 실행하는데 비용이 듦

### 서버 컴포넌트
- 컴포넌트를 서버에서 렌더링 / 정적 HTML이 아닌 트리를 전달하여 다른 컴포넌트에서 사용 가능


### 서버 사이드 렌더링과 서버 컴포넌트는 상호보완하는 개념
- 모두 채택하면 어떻게 될까?
- 서버컴포넌트를 활용해 서버에서 렌더링할 수 잇는 컴포넌트는 서버에서 완성해서 제공, 클라이언트 컴포넌트는 서버 사이드 렌더링으로 초기 HTML으로 빠르게 전달 받을 수 있다. 
- 컴포넌트를 빠르게 보여주고, 클라이언트에서 받아야하는 자바스크립트 파일도 줄어듦

## 서버 컴포넌트는 어떻게 작동하는가?
1. 서버가 렌더링 요청을 받는다. 서버가 렌더링 과정을 수행해야 하므로 리액트 서버 컴포넌트를 사용하는 모든 페이지는 항상 서버에서 시작된다. 즉 루트에 있는 컴포넌트는 항상 서버 컴포넌트다.
2. 서버는 받은 요청에 따라 컴포넌트를 JSON으로 직렬화한다. 이때 서버에서 렌더링할 수 있는 것은 직렬화해서 내보내고, 클라이언트 컴포넌트로 표시된 부분은 해당 공간을 플레이스홀더 형식으로 비워두고 나타낸다. 브라우저는 이후에 이 결과물을 받아서 다시 역직렬화한 다음 렌더링을 수행
3. 브라우저가 리액트 컴포넌트 트리를 구성(M 요소는 렌더링 진행, 이외는 파싱하여 트리 재구성)

### 서버 컴포넌트는 왜 특별한가?
- 서버에서 클라이언트로 정보를 보낼 때 스트리밍 형태로 보냄으로써 클라이언트가 줄 단위로 JSON을 읽고 컴포넌트를 렌더링할 수 있어 브라우저에서는 되도록 빨리 사용자에게 결과물을 보여줄 수 있다.
- 컴포넌트들이 하나의 번들러 작업에 포함돼 있지 않고, 각 컴포넌트별로 번들링이 별개로 돼 있어 필요에 따라 컴포넌트를 지연해서 받거나 따로 받는 등의 작업이 가능
- 서버 사이드 렌더링과 다르게 결과물이 HTML이 아닌 JSON형태로 보내져 HTML를 보내는 구조에서보다 클라이언트 사이드 렌더링의 장점을 채택할 수 있다.